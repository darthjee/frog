version: '2'
services:
  frog_mongo:
    image: mongo:3.4
    container_name: frog_mongo
    env_file: .env
    ports:
      - 127.0.0.1:$FROG_MONGO_PORT:27017
    volumes:
      - frog_mongo_server_database:/data/db
  frog_postgres:
    image: postgres:9.5
    container_name: frog_postgres
    env_file: .env
    environment:
      POSTGRES_USER: frog
      POSTGRES_PASSWORD: frog
    ports:
      - 127.0.0.1:$FROG_POSTGRES_PORT:5432
  frog_mongo_console:
    image: mongo:3.4
    container_name: frog_mongo_console
    env_file: .env
    command: mongo --host server
    links:
      - frog_mongo:server

  #################### Base  ####################

  base_rails: &base_rails
    build:
      context: ./
      dockerfile: Dockerfile.rails
    env_file: .env
    links:
      - frog_postgres:postgres
      - frog_mongo:mongo
    volumes:
      - .:/home/app/app
      - frog_gems_2_4_0:/usr/local/bundle

  base_node: &base_node
    build:
      context: ./
      dockerfile: Dockerfile.node
    env_file: .env
    links:
      - frog_mongo:mongo
    volumes:
      - ./node:/home/node/app

  ################## Rails CONTAINERS #################

  frog_rails_app:
    <<: *base_rails
    container_name: frog_rails_app
    command: /bin/bash bin/server.sh
    ports:
      - 0.0.0.0:3000:3000
    environment:
      - RAILS_ENV=development
      - FROG_POSTGRES_PORT=5432
      - FROG_MONGO_PORT=27017

  frog_rails_tests:
    <<: *base_rails
    container_name: frog_rails_tests
    command: /bin/bash bin/tests.sh
    environment:
      - RAILS_ENV=test

  frog_rails_root:
    <<: *base_rails
    user: root
    container_name: frog_rails_root
    command: /bin/bash

  ################# Node CONTAINERS ###################

  frog_node_app:
    <<: *base_node
    container_name: frog_node_app
    command: /bin/bash
    ports:
      - 0.0.0.0:3000:3000

networks:
  default:
    external:
      name: frog

volumes:
  frog_gems_2_4_0:
  frog_mongo_server_database:
